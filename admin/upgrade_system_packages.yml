---
- name: Upgrade system packages
  hosts: all:!unmanaged_systems:!localhost
  become: true
  tasks:
    - name: Update apt cache on Ubuntu machines
      when: ansible_distribution == 'Ubuntu'
      ansible.builtin.apt:
        update_cache: true
      tags:
        - non_idempotent

    - name: Upgrade system packages
      when: _rebootable | bool
      ansible.builtin.package:
        name: '*'
        state: latest  # noqa package-latest
      tags:
        - non_idempotent
