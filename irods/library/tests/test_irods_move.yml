---
- name: Test irods_move module
  hosts: localhost
  gather_facts: false
  vars:
    test_src: /testing/home/rods/test_src
    test_dest: /testing/home/rods/test_dst
    test_dest1: /testing/home/rods/test_dst1
  environment:
    TEST_PORT: '1247'
    TEST_USER_NAME: rods
    TEST_HOST: "{{ groups['irods_catalog'][0] }}"
    TEST_PASSWORD: rods
    TEST_ZONE_NAME: testing

  pre_tasks:
    - name: Create test objects
      ansible.builtin.shell:
        executable: /bin/bash
        cmd: |
          set -o errexit
          if ! [[ -e /var/lib/irods/irods/.irodsA ]]; then
            iinit <<< "$IRODS_PASSWORD" &> /dev/null
            imkdir '{{ test_src }}' &> /dev/null
            echo changed
          fi
      register: resp
      changed_when: resp.stdout == 'changed'

  tasks:
    - name: Neither source nor destination exist
      failed_when: response is succeeded
      irods_move:
        source: /testing/home/rods/null
        destination: /testing/home/rods/null
        host: "{{ groups['irods_catalog'][0] }}"
        port: 1247
        admin_user: rods
        admin_password: rods
        zone: testing
      register: response

    - name: Move collection
      irods_move:
        source: "{{ test_src }}"
        destination: "{{ test_dest }}"
        host: "{{ groups['irods_catalog'][0] }}"
        port: 1247
        admin_user: rods
        admin_password: rods
        zone: testing
      register: response

    - name: Verify move
      changed_when: false
      ansible.builtin.shell:
        executable: /bin/bash
        cmd: |
          if ! ils {{ test_src }} && ils {{ test_dest }}; then
            exit 0
          else
            exit 1
          fi

    - name: Test if source and destination are identical
      failed_when: response is changed or response is succeeded
      irods_move:
        source: "{{ test_dest }}"
        destination: "{{ test_dest }}"
        host: "{{ groups['irods_catalog'][0] }}"
        port: 1247
        admin_user: rods
        admin_password: rods
        zone: testing
      register: response
