---
- name: Test irods_move module
  hosts: irods_catalog
  become: true
  become_user: irods
  run_once: true
  vars:
    password: password
    src1: /testing/home/rods/src1
    src2: /testing/home/rods/src2
    bad_src: /testing/home/rods/missing_src
    dest1: /testing/home/rods/dest1
    dest2: /testing/home/rods/dest2
  pre_tasks:
    - name: Create test objects
      ansible.builtin.shell:
        executable: /bin/bash
        cmd: |
          set -o errexit
          imkdir '{{ src1 }}' '{{ src2 }}'
      changed_when: true
      tags: non_idempotent

  tasks:
    - name: Move collection
      irods_move:
        source: "{{ src1 }}"
        destination: "{{ dest1 }}"
        host: "{{ ansible_hostname }}"
        port: 1247
        admin_user: rods
        admin_password: "{{ password }}"
        zone: testing

    - name: Verify move
      ansible.builtin.shell:
        executable: /bin/bash
        cmd: '! ils {{ src1 }} && ils {{ dest1 }}'
      changed_when: false

    - name: Test if source and destination are identical
      irods_move:
        source: "{{ src2 }}"
        destination: "{{ src2 }}"
        host: "{{ groups['irods_catalog'][0] }}"
        port: 1247
        admin_user: rods
        admin_password: "{{ password }}"
        zone: testing
      register: response
      failed_when: response is changed or response is succeeded

    - name: Test move of source that does not exist
      delegate_to: localhost
      become: false
      irods_move:
        source: "{{ bad_src }}"
        destination: "{{ dest2 }}"
        host: "{{ inventory_hostname }}"
        port: 1247
        admin_user: rods
        admin_password: "{{ password }}"
        zone: testing
      register: response
      failed_when: response is succeeded
