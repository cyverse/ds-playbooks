---
- name: Verify storage resource created
  import_playbook: mk_storage_resources.yml


- name: Test Configure iRODS for TerraREF
  hosts: irods_catalog
  become: true
  become_user: irods
  run_once: true
  tasks:
    - name: Test make TerraREF resource hierarchy
      ansible.builtin.shell:
        executable: /bin/bash
        cmd: |
          printf -v expHier 'terrarefRes:passthru\n└── terraref:unixfilesystem'
          actHier="$(ilsresc terrarefRes)"
          [[ "$actHier" == "$expHier" ]]
      changed_when: false

    - name: Test create project collection
      ansible.builtin.shell:
        executable: /bin/bash
        cmd: ils /testing/home/shared/terraref &> /dev/null
      changed_when: false

    - name: Verify that project collection has correct owner
      ansible.builtin.shell:
        executable: /bin/bash
        cmd: |
          set -o pipefail
          ils -A /testing/home/shared/terraref \
            | sed --quiet 2p \
            | grep --quiet terraref_mgr#testing:own
      changed_when: false
